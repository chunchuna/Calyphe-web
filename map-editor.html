<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿·å®«åœ°å›¾ç¼–è¾‘å™¨</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        h1 {
            color: #333;
        }
        
        .editor-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        
        .control-group {
            margin: 10px;
        }
        
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button.selected {
            background-color: #2196F3;
        }
        
        .map-grid {
            display: inline-block;
            border: 2px solid #333;
            margin: 20px 0;
            overflow: auto;
        }
        
        .grid-row {
            display: flex;
        }
        
        .grid-cell {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            background-color: white;
            cursor: pointer;
        }
        
        .cell-wall {
            background-color: #333;
        }
        
        .cell-player {
            background-color: blue;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            margin-top: 20px;
            font-family: monospace;
            resize: vertical;
        }
        
        .cell-npc {
            background-color: green;
            position: relative;
        }
        
        .cell-npc::after {
            content: 'N';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
        }
        
        .npc-panel {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        .npc-preview {
            display: flex;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .npc-icon {
            font-size: 2em;
            margin-right: 10px;
        }
        
        .npc-info {
            flex: 1;
        }
        
        .npc-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <h1>è¿·å®«åœ°å›¾ç¼–è¾‘å™¨</h1>
        
        <div class="controls">
            <div class="control-group">
                <button id="btnWall" class="selected">å¢™å£ (#)</button>
                <button id="btnPlayer">ç©å®¶ (P)</button>
                <button id="btnNpc">NPC (N)</button>
                <button id="btnEmpty">ç©ºç™½</button>
            </div>
            
            <div class="control-group">
                <label for="mapWidth">å®½åº¦: </label>
                <input type="number" id="mapWidth" value="20" min="5" max="50">
                <label for="mapHeight">é«˜åº¦: </label>
                <input type="number" id="mapHeight" value="15" min="5" max="50">
                <button id="btnResize">è°ƒæ•´å¤§å°</button>
            </div>
            
            <div class="control-group">
                <button id="btnClear">æ¸…ç©ºåœ°å›¾</button>
                <button id="btnReset">é‡ç½®</button>
                <button id="btnGenerateBorder">ç”Ÿæˆè¾¹æ¡†</button>
            </div>
            
            <div class="control-group">
                <button id="btnExport">å¯¼å‡ºåœ°å›¾</button>
                <button id="btnImport">å¯¼å…¥åœ°å›¾</button>
            </div>
        </div>
        
        <div id="mapGrid" class="map-grid"></div>
        
        <textarea id="mapOutput" placeholder="åœ°å›¾ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
        
        <div id="npcPanel" class="npc-panel" style="display: none;">
            <h3>NPCé…ç½®</h3>
            <select id="npcId">
                <option value="">é€‰æ‹©NPC...</option>
            </select>
            <div id="npcPreview" class="npc-preview">
                <div class="npc-icon"></div>
                <div class="npc-info">
                    <div class="npc-name"></div>
                    <div class="npc-items"></div>
                    <div class="npc-function"></div>
                </div>
            </div>
            <button id="confirmNpc">ç¡®è®¤</button>
            <button id="cancelNpc">å–æ¶ˆ</button>
        </div>
    </div>
    
    <script>
        // ç›´æ¥åœ¨HTMLä¸­å®šä¹‰NPCé…ç½®ï¼Œé¿å…é€šè¿‡fetchåŠ è½½
        const npcConfig = {
            "1": {
                id: "1",
                name: "æ‘é•¿",
                sprite: "ğŸ‘´",
                items: ["ä»»åŠ¡å·è½´", "é’¥åŒ™"],
                dialogue: "æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„æ‘åº„ï¼Œå¹´è½»äººï¼",
                function: "quest_giver"
            },
            "2": {
                id: "2",
                name: "å•†äºº",
                sprite: "ğŸ‘¨",
                items: ["è¯æ°´", "å‰‘", "ç›¾ç‰Œ"],
                dialogue: "è¦ä¹°äº›ä»€ä¹ˆå—ï¼Ÿæˆ‘è¿™é‡Œåº”æœ‰å°½æœ‰ï¼",
                function: "shop"
            },
            "3": {
                id: "3",
                name: "é“åŒ ",
                sprite: "ğŸ”¨",
                items: ["é“å‰‘", "é“ç›¾"],
                dialogue: "éœ€è¦æ­¦å™¨è£…å¤‡å—ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ æ‰“é€ ï¼",
                function: "blacksmith"
            },
            "4": {
                id: "4",
                name: "å†œæ°‘",
                sprite: "ğŸ‘©â€ğŸŒ¾",
                items: ["å°éº¦", "èƒ¡èåœ"],
                dialogue: "ä»Šå¹´çš„æ”¶æˆä¸é”™ï¼",
                function: "none"
            },
            "5": {
                id: "5",
                name: "å®ˆå«",
                sprite: "ğŸ’‚",
                items: ["é’¢å‰‘"],
                dialogue: "æ­¢æ­¥ï¼è¿™é‡Œæ˜¯ç¦åœ°ï¼",
                function: "guard"
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const mapGrid = document.getElementById('mapGrid');
            const mapOutput = document.getElementById('mapOutput');
            const mapWidthInput = document.getElementById('mapWidth');
            const mapHeightInput = document.getElementById('mapHeight');
            
            // å·¥å…·æŒ‰é’®
            const btnWall = document.getElementById('btnWall');
            const btnPlayer = document.getElementById('btnPlayer');
            const btnEmpty = document.getElementById('btnEmpty');
            const btnNpc = document.getElementById('btnNpc');
            
            // åŠŸèƒ½æŒ‰é’®
            const btnResize = document.getElementById('btnResize');
            const btnClear = document.getElementById('btnClear');
            const btnReset = document.getElementById('btnReset');
            const btnGenerateBorder = document.getElementById('btnGenerateBorder');
            const btnExport = document.getElementById('btnExport');
            const btnImport = document.getElementById('btnImport');
            
            // æ–°å¢NPCç›¸å…³DOMå…ƒç´ å’Œå˜é‡
            const npcPanel = document.getElementById('npcPanel');
            const npcIdSelect = document.getElementById('npcId');
            const npcPreview = document.getElementById('npcPreview');
            const confirmNpcBtn = document.getElementById('confirmNpc');
            const cancelNpcBtn = document.getElementById('cancelNpc');
            
            // NPCå›¾æ ‡å’Œä¿¡æ¯å…ƒç´ 
            const npcIcon = npcPreview.querySelector('.npc-icon');
            const npcName = npcPreview.querySelector('.npc-name');
            const npcItems = npcPreview.querySelector('.npc-items');
            const npcFunction = npcPreview.querySelector('.npc-function');
            
            // å½“å‰é€‰æ‹©çš„å·¥å…·
            let currentTool = 'wall'; // 'wall', 'player', 'empty', 'npc'
            
            // åœ°å›¾æ•°æ®
            let mapData = [];
            let playerPosition = { x: -1, y: -1 }; // è·Ÿè¸ªç©å®¶ä½ç½®
            // é¼ æ ‡æŒ‰ä¸‹çŠ¶æ€
            let isMouseDown = false;
            
            // æ–°å¢NPCæ•°æ® - å­˜å‚¨åœ¨åœ°å›¾ä¸Šçš„NPCçš„IDå’Œä½ç½®
            let mapNpcs = {};
            
            // å½“å‰å¾…æ”¾ç½®çš„NPC ID
            let currentNpcId = '';
            
            // åŠ è½½NPCé…ç½®æ•°æ®
            function loadNpcConfig() {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å…¨å±€npcConfigå¯¹è±¡ï¼ˆæ¥è‡ªå†…è”è„šæœ¬æˆ–å·²åŠ è½½çš„å¤–éƒ¨è„šæœ¬ï¼‰
                if (typeof npcConfig !== 'undefined') {
                    populateNpcSelect();
                    return;
                }
                
                // å¦‚æœæ²¡æœ‰é¢„å®šä¹‰çš„é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
                window.npcConfig = {
                    "1": {
                        id: "1",
                        name: "æ‘é•¿", 
                        sprite: "ğŸ‘´",
                        items: ["ä»»åŠ¡å·è½´"],
                        dialogue: "æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„æ‘åº„ï¼",
                        function: "quest_giver"
                    },
                    "2": {
                        id: "2", 
                        name: "å•†äºº", 
                        sprite: "ğŸ‘¨",
                        items: ["è¯æ°´", "å‰‘"],
                        dialogue: "è¦ä¹°äº›ä»€ä¹ˆå—ï¼Ÿ",
                        function: "shop"
                    }
                };
                
                console.log('ä½¿ç”¨é»˜è®¤NPCé…ç½®');
                populateNpcSelect();
            }
            
            // å¡«å……NPCé€‰æ‹©ä¸‹æ‹‰æ¡†
            function populateNpcSelect() {
                npcIdSelect.innerHTML = '<option value="">é€‰æ‹©NPC...</option>';
                for (const id in npcConfig) {
                    const npc = npcConfig[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.text = `${id}: ${npc.name} (${npc.function})`;
                    npcIdSelect.appendChild(option);
                }
            }
            
            // æ›´æ–°NPCé¢„è§ˆ
            function updateNpcPreview(id) {
                if (id && npcConfig[id]) {
                    const npc = npcConfig[id];
                    npcIcon.textContent = npc.sprite || 'N';
                    npcName.textContent = npc.name;
                    npcItems.textContent = `ç‰©å“: ${npc.items.join(', ')}`;
                    npcFunction.textContent = `åŠŸèƒ½: ${npc.function}`;
                    npcPreview.style.display = 'flex';
                } else {
                    npcPreview.style.display = 'none';
                }
            }
            
            // NPCé€‰æ‹©å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
            npcIdSelect.addEventListener('change', function() {
                updateNpcPreview(this.value);
            });
            
            // ç¡®è®¤NPCé€‰æ‹©
            confirmNpcBtn.addEventListener('click', function() {
                currentNpcId = npcIdSelect.value;
                if (!currentNpcId) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªNPC');
                    return;
                }
                npcPanel.style.display = 'none';
                // ç»§ç»­ä½¿ç”¨NPCå·¥å…·
            });
            
            // å–æ¶ˆNPCé€‰æ‹©
            cancelNpcBtn.addEventListener('click', function() {
                npcPanel.style.display = 'none';
                setActiveTool('empty'); // åˆ‡æ¢å›ç©ºç™½å·¥å…·
            });
            
            // ç‚¹å‡»NPCå·¥å…·æŒ‰é’®
            btnNpc.addEventListener('click', function() {
                setActiveTool('npc');
                npcPanel.style.display = 'block';
                if (npcIdSelect.options.length <= 1) {
                    loadNpcConfig();
                }
            });
            
            // åˆå§‹åŒ–åœ°å›¾
            function initMap(width, height, preserveContent = false) {
                const oldData = preserveContent ? [...mapData] : null;
                const oldWidth = preserveContent ? (mapData[0] ? mapData[0].length : 0) : 0;
                const oldHeight = preserveContent ? mapData.length : 0;
                
                // åˆ›å»ºæ–°åœ°å›¾æ•°æ®
                mapData = [];
                for (let y = 0; y < height; y++) {
                    const row = [];
                    for (let x = 0; x < width; x++) {
                        // å¦‚æœæ˜¯ä¿ç•™å†…å®¹æ¨¡å¼ï¼Œä¸”åœ¨æ—§åœ°å›¾èŒƒå›´å†…ï¼Œå¤åˆ¶æ—§å†…å®¹
                        if (preserveContent && y < oldHeight && x < oldWidth) {
                            row.push(oldData[y][x]);
                        } else {
                            row.push(' ');
                        }
                    }
                    mapData.push(row);
                }
                
                // å¦‚æœä¿ç•™å†…å®¹ï¼Œæ£€æŸ¥ç©å®¶ä½ç½®æ˜¯å¦ä»åœ¨åœ°å›¾å†…
                if (preserveContent && playerPosition.x !== -1 && playerPosition.y !== -1) {
                    if (playerPosition.x >= width || playerPosition.y >= height) {
                        playerPosition = { x: -1, y: -1 };
                    }
                } else {
                    // é‡ç½®ç©å®¶ä½ç½®
                    playerPosition = { x: -1, y: -1 };
                }
                
                // é‡æ–°æ¸²æŸ“åœ°å›¾
                renderMap();
            }
            
            // æ¸²æŸ“åœ°å›¾åˆ°ç½‘æ ¼
            function renderMap() {
                // æ¸…ç©ºå½“å‰ç½‘æ ¼
                mapGrid.innerHTML = '';
                
                // åˆ›å»ºæ–°çš„ç½‘æ ¼
                for (let y = 0; y < mapData.length; y++) {
                    const rowElement = document.createElement('div');
                    rowElement.className = 'grid-row';
                    
                    for (let x = 0; x < mapData[y].length; x++) {
                        const cellElement = document.createElement('div');
                        cellElement.className = 'grid-cell';
                        cellElement.dataset.x = x;
                        cellElement.dataset.y = y;
                        
                        if (mapData[y][x] === '#') {
                            cellElement.classList.add('cell-wall');
                        } else if (mapData[y][x] === 'P') {
                            cellElement.classList.add('cell-player');
                        } else if (mapData[y][x] === 'N') {
                            cellElement.classList.add('cell-npc');
                        }
                        
                        rowElement.appendChild(cellElement);
                    }
                    
                    mapGrid.appendChild(rowElement);
                }
                
                // æ›´æ–°æ–‡æœ¬åŒºåŸŸ
                updateMapOutput();
            }
            
            // å®Œå…¨ç§»é™¤è¿™ä¸‰ä¸ªå•ç‹¬çš„å¤„ç†å‡½æ•°
            // handleCellClick, handleMouseDown, handleMouseEnter
            
            // æ”¹ä¸ºä½¿ç”¨å…¨å±€çš„äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰æƒ…å†µ
            mapGrid.addEventListener('mousedown', function(event) {
                if (event.target.classList.contains('grid-cell')) {
                    isMouseDown = true;
                    const x = parseInt(event.target.dataset.x);
                    const y = parseInt(event.target.dataset.y);
                    
                    console.log('é¼ æ ‡æŒ‰ä¸‹', x, y, 'å½“å‰å·¥å…·:', currentTool);
                    applyTool(x, y);
                    renderMap();
                    
                    // é˜²æ­¢æ‹–åŠ¨æ—¶è§¦å‘é€‰æ‹©æ“ä½œ
                    event.preventDefault();
                }
            });
            
            mapGrid.addEventListener('mousemove', function(event) {
                if (!isMouseDown) return; // ç¡®ä¿åªæœ‰åœ¨é¼ æ ‡æŒ‰ä¸‹æ—¶æ‰å¤„ç†
                
                if (event.target.classList.contains('grid-cell')) {
                    const x = parseInt(event.target.dataset.x);
                    const y = parseInt(event.target.dataset.y);
                    
                    applyTool(x, y);
                    renderMap();
                }
            });
            
            // é¼ æ ‡æŠ¬èµ·ï¼Œåœæ­¢ç»˜åˆ¶
            document.addEventListener('mouseup', function() {
                isMouseDown = false;
            });
            
            // é¼ æ ‡ç¦»å¼€åœ°å›¾åŒºåŸŸä¹Ÿåœæ­¢ç»˜åˆ¶
            mapGrid.addEventListener('mouseleave', function() {
                isMouseDown = false;
            });
            
            // åº”ç”¨å½“å‰å·¥å…·åˆ°æŒ‡å®šä½ç½®
            function applyTool(x, y) {
                if (x === undefined || y === undefined || 
                    x < 0 || y < 0 || 
                    y >= mapData.length || 
                    x >= mapData[y].length) {
                    return; // é˜²æ­¢è¶Šç•Œ
                }
                
                console.log('åº”ç”¨å·¥å…·', currentTool, 'åœ¨ä½ç½®', x, y);
                
                // å¤„ç†ç©å®¶ä½ç½®
                if (currentTool === 'player') {
                    console.log('æ”¾ç½®ç©å®¶');
                    // å¦‚æœå·²ç»æœ‰ç©å®¶ï¼Œå…ˆç§»é™¤
                    if (playerPosition.x !== -1 && playerPosition.y !== -1) {
                        mapData[playerPosition.y][playerPosition.x] = ' ';
                    }
                    
                    // è®¾ç½®æ–°çš„ç©å®¶ä½ç½®
                    mapData[y][x] = 'P';
                    playerPosition = { x, y };
                } else if (currentTool === 'wall') {
                    // å¦‚æœå½“å‰ä½ç½®æ˜¯ç©å®¶ï¼Œæ›´æ–°ç©å®¶ä½ç½®
                    if (mapData[y][x] === 'P') {
                        playerPosition = { x: -1, y: -1 };
                    }
                    
                    mapData[y][x] = '#';
                } else if (currentTool === 'empty') {
                    // å¦‚æœå½“å‰ä½ç½®æ˜¯ç©å®¶ï¼Œæ›´æ–°ç©å®¶ä½ç½®
                    if (mapData[y][x] === 'P') {
                        playerPosition = { x: -1, y: -1 };
                    }
                    
                    mapData[y][x] = ' ';
                } else if (currentTool === 'npc') {
                    if (!currentNpcId) {
                        // å¦‚æœæ²¡æœ‰é€‰æ‹©NPCï¼Œæ˜¾ç¤ºé€‰æ‹©é¢æ¿
                        npcPanel.style.display = 'block';
                        return;
                    }
                    
                    // æ¸…é™¤è¯¥ä½ç½®çš„å…¶ä»–å…ƒç´ 
                    if (mapData[y][x] === 'P') {
                        playerPosition = { x: -1, y: -1 };
                    }
                    
                    // å­˜å‚¨NPCä½ç½®å’ŒID
                    mapNpcs[`${x},${y}`] = currentNpcId;
                    
                    // åœ¨åœ°å›¾æ•°æ®ä¸­æ ‡è®°ä¸ºN
                    mapData[y][x] = 'N';
                }
            }
            
            // æ›´æ–°æ–‡æœ¬è¾“å‡º
            function updateMapOutput() {
                let output = '';
                for (let y = 0; y < mapData.length; y++) {
                    for (let x = 0; x < mapData[y].length; x++) {
                        output += mapData[y][x];
                    }
                    output += '\n';
                }
                
                // æ·»åŠ NPCé…ç½®åˆ°è¾“å‡º
                const currentOutput = output;
                let npcLines = '\n// NPCé…ç½® æ ¼å¼: x,y:id\n// ';
                
                for (const pos in mapNpcs) {
                    npcLines += `${pos}:${mapNpcs[pos]} `;
                }
                
                output = currentOutput + npcLines;
                
                mapOutput.value = output;
            }
            
            // ä»æ–‡æœ¬è¾“å…¥è§£æåœ°å›¾
            function parseMapInput(text) {
                const lines = text.trim().split('\n');
                
                // è·å–æœ€å¤§è¡Œé•¿åº¦
                let maxLength = 0;
                for (const line of lines) {
                    maxLength = Math.max(maxLength, line.length);
                }
                
                // é‡ç½®ç©å®¶ä½ç½®
                playerPosition = { x: -1, y: -1 };
                
                // åˆ›å»ºæ–°çš„åœ°å›¾æ•°æ®
                mapData = [];
                for (let y = 0; y < lines.length; y++) {
                    const row = [];
                    for (let x = 0; x < maxLength; x++) {
                        if (x < lines[y].length) {
                            if (lines[y][x] === 'P') {
                                playerPosition = { x, y };
                            }
                            row.push(lines[y][x]);
                        } else {
                            row.push(' ');
                        }
                    }
                    mapData.push(row);
                }
                
                // æ›´æ–°è¾“å…¥æ¡†
                mapWidthInput.value = maxLength;
                mapHeightInput.value = lines.length;
                
                // æ¸…ç©ºç°æœ‰NPCæ•°æ®
                mapNpcs = {};
                
                renderMap();
            }
            
            // ç”Ÿæˆè¾¹æ¡†
            function generateBorder() {
                const width = mapData[0].length;
                const height = mapData.length;
                
                // é¡¶éƒ¨å’Œåº•éƒ¨è¾¹æ¡†
                for (let x = 0; x < width; x++) {
                    mapData[0][x] = '#';
                    mapData[height - 1][x] = '#';
                }
                
                // å·¦ä¾§å’Œå³ä¾§è¾¹æ¡†
                for (let y = 0; y < height; y++) {
                    mapData[y][0] = '#';
                    mapData[y][width - 1] = '#';
                }
                
                renderMap();
            }
            
            // å¯¼å‡ºåœ°å›¾åˆ°æ–‡ä»¶
            function exportMap() {
                updateMapOutput();
                const mapText = mapOutput.value;
                const blob = new Blob([mapText], {type: 'text/plain'});
                const a = document.createElement('a');
                a.download = 'map.txt';
                a.href = URL.createObjectURL(blob);
                a.click();
            }
            
            // è®¾ç½®æŒ‰é’®äº‹ä»¶ - å·¥å…·é€‰æ‹©
            btnWall.addEventListener('click', function() {
                console.log('å¢™å£æŒ‰é’®è¢«ç‚¹å‡»');
                setActiveTool('wall');
            });
            
            btnPlayer.addEventListener('click', function() {
                console.log('ç©å®¶æŒ‰é’®è¢«ç‚¹å‡»');
                setActiveTool('player');
            });
            
            btnEmpty.addEventListener('click', function() {
                console.log('ç©ºç™½æŒ‰é’®è¢«ç‚¹å‡»');
                setActiveTool('empty');
            });
            
            btnResize.addEventListener('click', function() {
                const width = parseInt(mapWidthInput.value);
                const height = parseInt(mapHeightInput.value);
                
                if (width >= 5 && width <= 50 && height >= 5 && height <= 50) {
                    // ä¼ å…¥trueè¡¨ç¤ºä¿ç•™ç°æœ‰å†…å®¹
                    initMap(width, height, true);
                } else {
                    alert('å®½åº¦å’Œé«˜åº¦å¿…é¡»åœ¨5åˆ°50ä¹‹é—´');
                }
            });
            
            btnClear.addEventListener('click', function() {
                const width = mapData[0].length;
                const height = mapData.length;
                initMap(width, height);
            });
            
            btnReset.addEventListener('click', function() {
                const defaultWidth = 20;
                const defaultHeight = 15;
                
                mapWidthInput.value = defaultWidth;
                mapHeightInput.value = defaultHeight;
                
                initMap(defaultWidth, defaultHeight);
            });
            
            btnGenerateBorder.addEventListener('click', generateBorder);
            
            btnExport.addEventListener('click', exportMap);
            
            btnImport.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const content = e.target.result;
                            parseMapInput(content);
                        };
                        reader.readAsText(file);
                    }
                };
                
                input.click();
            });
            
            mapOutput.addEventListener('input', function() {
                parseMapInput(mapOutput.value);
            });
            
            // è®¾ç½®æ´»åŠ¨å·¥å…·
            function setActiveTool(tool) {
                console.log('è®¾ç½®å·¥å…·ä»', currentTool, 'åˆ°', tool);
                // è®¾ç½®å½“å‰å·¥å…·
                currentTool = tool;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                btnWall.classList.remove('selected');
                btnPlayer.classList.remove('selected');
                btnEmpty.classList.remove('selected');
                btnNpc.classList.remove('selected');
                
                if (tool === 'wall') {
                    btnWall.classList.add('selected');
                } else if (tool === 'player') {
                    btnPlayer.classList.add('selected');
                } else if (tool === 'empty') {
                    btnEmpty.classList.add('selected');
                } else if (tool === 'npc') {
                    btnNpc.classList.add('selected');
                }
                
                console.log('å½“å‰å·¥å…·ç°åœ¨æ˜¯:', currentTool); 
            }
            
            // åˆå§‹åŒ–åœ°å›¾
            initMap(parseInt(mapWidthInput.value), parseInt(mapHeightInput.value));
        });
    </script>
</body>
</html> 